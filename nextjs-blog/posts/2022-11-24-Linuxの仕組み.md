---
title: "Linuxのしくみ 読書メモ"
date: "2022-11-24"
---

# Linuxのしくみ

評判が良かったのと、いい加減一回くらい入門書読まないとなと思ったので流れで買った

## はじめに
この本を読むと下記の事柄が学べる らしいぞ
- カーネルやハードウェアの低レイヤー原因トラブルの解析
- 性能を意識したコーディング
- システムの各種統計情報、チューニングパラメータの意味の理解

[githubにコードがある](https://github.com/satoru-takeuchi/linux-in-practice-2nd)
初期設定もここに書いてある

# 1章 Linuxの概要

- 直接ストレージにアクセスすると、プロセスが書き換え合戦を起こしてやばい
- 間にカーネルを挟んで対応する
- CPUにいくつかモードがある(linuxでは２つ使う）
  - 制限のないカーネルモード
    - カーネルだけがこれで動く
  - 制限をつけられるユーザモード
    - カーネル以外のプロセスはみんなこっち
- システムコールはプロセスがカーネルにカーネルモードでの操作を依頼すること
  - これ以外でカーネルモードの操作をすることはできない

コマンド
- strace
  - システムコールをトレースするやつ？-Oでログを吐く
- sar
  - CPUの処理内容の内訳みたいなのが見える idle100%とか
- taskset
  - 指定したコマンドを指定のCPUで実行する
- ldd
  - ライブラリのリンクを確認する
- dpkg-query
  - ライブラリ検索するのに使ってた

## 監視・アラート・ダッシュボード
今は常に動いてるサーバ持ってないので関係ないけど
そのうち動かすようになったらこのあたりも読めるようにならないと
多分awsとかにも応用が効く

## ライブラリ
OSレベルでライブラリを持っている  
頻繁に使うような処理はココに入る  
linuxはC標準ライブラリ glibc 通称libcが入ってるっぽい  
lddコマンドでライブラリのリンクを確認できる  
echoもcatもpython3もみんな裏ではCを呼んでた

### ラッパー関数
libcにはシステムコールのラッパー関数も入ってる  
システムコールはアセンブリでしか呼べないのでラッパーがないとつらい

- 静的ライブラリ
  - コンパイルの中に含める
- 動的ライブラリ(共有ライブラリ)
  - 呼び出しコードだけ書いておいて、後からライブラリはロードしてくる
- ライセンスまわり調べたときに一回見た話  
  - どちらかだけ許可してたりするので注意しないといけないやつ

- 長らく動的リンクが使われていたが最近は静的リンクが復権しつつあるらしい
- Go言語は静的リンクしかない？らしい
- 容量削減とかが問題じゃなくなった
- dll地獄(updateされると互換性が死ぬやつ)対策など

# ２章 プロセス管理(基礎編)

プロセスが生成されるのは大体２択
1. 同じプログラムの処理を複数のプロセスに分ける
2. 新しいプロセスを生成する

- fork()
  - cloneシステムコールを呼ぶ
  - 新しいメモリ領域に既存のプロセスをコピー
  - copy on write機能のおかげでコストが安いらしい
- execev()
  - execevシステムコールを呼ぶ
  - 既存のメモリ領域を引数の実行プログラムで上書きする
  - コードやデータのサイズ分メモリ領域を確保する(ELFの仕様)

複数に分けるだけならforkだけ、新しく作る場合は両方を使う。

- readelf()
  - エントリポイントとかサイズの情報を見られる